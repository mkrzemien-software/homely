<div class="system-users-view">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Zarządzanie Użytkownikami</h1>
        <p class="subtitle">Zarządzaj wszystkimi kontami użytkowników w systemie</p>
      </div>
      <div class="header-actions">
        <p-button
          label="Powrót do Dashboard"
          icon="pi pi-arrow-left"
          [outlined]="true"
          routerLink="/system/dashboard"
          styleClass="back-button"
        ></p-button>
        <p-button
            label="Dodaj użytkownika"
            icon="pi pi-user-plus"
            (onClick)="showCreateDialog()"
            styleClass="create-user-button"
          ></p-button>
      </div>
    </div>
  </div>

  <!-- Search Component -->
  <app-global-user-search (search)="onSearch($event)"></app-global-user-search>

  <!-- Users Table -->
  <p-card>
    @if (isLoading()) {
      <!-- Loading Skeleton -->
      <div class="loading-skeleton">
        <p-skeleton height="3rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="3rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="3rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="3rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="3rem"></p-skeleton>
      </div>
    } @else if (hasUsers()) {
      <!-- Users Table -->
      <p-table
        [value]="users()"
        [tableStyle]="{ 'min-width': '100%' }"
        styleClass="p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Użytkownik</th>
            <th>Email</th>
            <th>Gospodarstwo</th>
            <th>Rola</th>
            <th>Status</th>
            <th>Ostatnie logowanie</th>
            <th class="actions-column">Akcje</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-user>
          <tr>
            <!-- User Name -->
            <td>
              <div class="user-cell">
                <div class="user-avatar-small">
                  {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                </div>
                <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
              </div>
            </td>

            <!-- Email -->
            <td>{{ user.email }}</td>

            <!-- Household -->
            <td>{{ user.householdName }}</td>

            <!-- Role -->
            <td>
              <p-tag
                [value]="getRoleLabel(user.role)"
                [severity]="getRoleSeverity(user.role)"
              ></p-tag>
            </td>

            <!-- Status -->
            <td>
              <p-tag
                [value]="getStatusLabel(user.status)"
                [severity]="getStatusSeverity(user.status)"
              ></p-tag>
            </td>

            <!-- Last Login -->
            <td>{{ formatDate(user.lastLogin) }}</td>

            <!-- Actions -->
            <td class="actions-column">
              <p-button
                icon="pi pi-eye"
                [rounded]="true"
                [text]="true"
                severity="info"
                (onClick)="selectUser(user)"
                pTooltip="Zobacz szczegóły"
                tooltipPosition="left"
              ></p-button>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <!-- Pagination -->
      <p-paginator
        [rows]="pageSize()"
        [totalRecords]="totalUsers()"
        [rowsPerPageOptions]="[10, 20, 50, 100]"
        (onPageChange)="onPageChange($event)"
        styleClass="mt-3"
      ></p-paginator>
    } @else {
      <!-- No Users Found -->
      <div class="no-users">
        <i class="pi pi-users" style="font-size: 3rem"></i>
        <h3>Nie znaleziono użytkowników</h3>
        <p>Spróbuj dostosować filtry wyszukiwania</p>
      </div>
    }
  </p-card>

  <!-- User Details Sidebar -->
  <p-sidebar
    [(visible)]="sidebarVisible"
    position="right"
    [style]="{ width: '50rem' }"
    [modal]="true"
    (onHide)="closeSidebar()"
  >
    @if (selectedUser()) {
      <ng-template pTemplate="header">
        <h2>Szczegóły użytkownika</h2>
      </ng-template>

      <ng-template pTemplate="content">
        <div class="sidebar-content">
          <!-- Account Actions Toolbar -->
          <app-account-actions-toolbar
            [user]="selectedUser()!"
            (actionCompleted)="onActionCompleted()"
          ></app-account-actions-toolbar>

          <!-- User Details -->
          <app-user-details-panel [user]="selectedUser()!"></app-user-details-panel>

          <!-- Role Management -->
          <div class="role-management-section">
            <app-role-management-form
              [user]="selectedUser()!"
              (roleUpdated)="onRoleUpdated($event)"
            ></app-role-management-form>
          </div>
        </div>
      </ng-template>
    }
  </p-sidebar>

  <!-- Create User Dialog -->
  <p-dialog
    [(visible)]="createDialogVisible"
    [modal]="true"
    [style]="{ width: '40rem' }"
    header="Utwórz nowego użytkownika"
    (onHide)="hideCreateDialog()"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
  >
    <app-create-user-dialog
      (userCreated)="onUserCreated()"
      (dialogClosed)="hideCreateDialog()"
    />
  </p-dialog>
</div>
