<div class="system-households-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Zarządzanie Gospodarstwami</h1>
      <p class="subtitle">Administracja gospodarstwami w całym systemie</p>
    </div>
    <div class="header-right">
      <p-button
        icon="pi pi-refresh"
        [rounded]="true"
        [text]="true"
        severity="secondary"
        (onClick)="refresh()"
      />
      <p-button
        label="Powrót do Dashboard"
        icon="pi pi-arrow-left"
        [outlined]="true"
        routerLink="/system/dashboard"
      />
      <p-button
        label="Utwórz Gospodarstwo"
        icon="pi pi-plus"
        (onClick)="showCreateDialog()"
      />
    </div>
  </div>

  <!-- Statistics Cards -->
  @if (householdStats()) {
    <div class="stats-grid">
      <p-card class="stat-card">
        <div class="stat-content">
          <i class="pi pi-home stat-icon"></i>
          <div class="stat-details">
            <div class="stat-value">{{ householdStats()!.totalHouseholds }}</div>
            <div class="stat-label">Wszystkie Gospodarstwa</div>
          </div>
        </div>
      </p-card>

      <p-card class="stat-card">
        <div class="stat-content">
          <i class="pi pi-check-circle stat-icon success"></i>
          <div class="stat-details">
            <div class="stat-value">{{ householdStats()!.activeHouseholds }}</div>
            <div class="stat-label">Aktywne</div>
          </div>
        </div>
      </p-card>

      <p-card class="stat-card">
        <div class="stat-content">
          <i class="pi pi-users stat-icon info"></i>
          <div class="stat-details">
            <div class="stat-value">{{ householdStats()!.totalMembers }}</div>
            <div class="stat-label">Wszyscy Członkowie</div>
          </div>
        </div>
      </p-card>

      <p-card class="stat-card">
        <div class="stat-content">
          <i class="pi pi-box stat-icon warning"></i>
          <div class="stat-details">
            <div class="stat-value">{{ householdStats()!.totalItems }}</div>
            <div class="stat-label">Wszystkie Elementy</div>
          </div>
        </div>
      </p-card>
    </div>
  }

  <!-- Search and Filters -->
  <p-card class="search-card">
    <div class="search-container">
      <span class="p-input-icon-left flex-1">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          placeholder="Szukaj po nazwie lub adresie gospodarstwa..."
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
          class="w-full"
        />
      </span>
      <p-button
        label="Szukaj"
        icon="pi pi-search"
        (onClick)="onSearch()"
      />
      <p-button
        label="Wyczyść"
        icon="pi pi-times"
        severity="secondary"
        [text]="true"
        (onClick)="clearSearch()"
      />
    </div>
  </p-card>

  <!-- Households Table -->
  <p-card class="table-card">
    @if (isLoading()) {
      <div class="loading-container">
        <p-skeleton height="4rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="4rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="4rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton height="4rem" styleClass="mb-2"></p-skeleton>
      </div>
    } @else {
      <p-table
        [value]="households()"
        [rows]="pageSize()"
        [rowHover]="true"
        styleClass="p-datatable-striped"
        [tableStyle]="{ 'min-width': '60rem' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Nazwa</th>
            <th>Adres</th>
            <th>Plan</th>
            <th>Status</th>
            <th>Członkowie</th>
            <th>Elementy</th>
            <th>Wydarzenia</th>
            <th>Utworzono</th>
            <th class="text-center">Akcje</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-household>
          <tr
            class="clickable-row"
            (click)="viewHouseholdDetails(household)"
          >
            <td>
              <div class="household-name">
                <strong>{{ household.name }}</strong>
                @if (household.isDeleted) {
                  <p-tag value="Deleted" severity="danger" />
                }
              </div>
            </td>
            <td>{{ household.address || 'N/A' }}</td>
            <td>{{ household.planName }}</td>
            <td>
              <p-tag
                [value]="getStatusLabel(household.subscriptionStatus)"
                [severity]="getStatusSeverity(household.subscriptionStatus)"
              />
            </td>
            <td>{{ household.memberCount }}</td>
            <td>{{ household.itemCount }}</td>
            <td>{{ household.taskCount }}</td>
            <td>{{ formatDate(household.createdAt) }}</td>
            <td class="text-center">
              <div class="action-buttons">
                <p-button
                  icon="pi pi-eye"
                  [rounded]="true"
                  [text]="true"
                  severity="info"
                  (onClick)="viewHouseholdDetails(household)"
                  pTooltip="Zobacz szczegóły"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  (onClick)="deleteHousehold(household, $event)"
                  pTooltip="Usuń gospodarstwo"
                />
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9" class="text-center">
              <div class="empty-state">
                <i class="pi pi-inbox empty-icon"></i>
                <p class="empty-text">Nie znaleziono gospodarstw</p>
                <p class="empty-subtext">Spróbuj dostosować kryteria wyszukiwania</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <!-- Pagination -->
      @if (hasHouseholds()) {
        <p-paginator
          [rows]="pageSize()"
          [totalRecords]="totalHouseholds()"
          [rowsPerPageOptions]="[10, 20, 50, 100]"
          (onPageChange)="onPageChange($event)"
        ></p-paginator>
      }
    }
  </p-card>

  <!-- Details Dialog -->
  <p-dialog
    [(visible)]="detailsDialogVisible"
    [modal]="true"
    [style]="{ width: '50rem' }"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    header="Szczegóły gospodarstwa"
    (onHide)="closeDetailsDialog()"
    styleClass="household-details-dialog"
  >
    @if (selectedHousehold()) {
      <p-card>
        <ng-template pTemplate="header">
          <div class="household-header">
            <div class="household-icon">
              <i class="pi pi-home"></i>
            </div>
            <div class="household-info">
              <h2>{{ selectedHousehold()!.name }}</h2>
              <p class="household-address">{{ selectedHousehold()!.address || 'Brak adresu' }}</p>
            </div>
          </div>
        </ng-template>

        <!-- Basic Information -->
        <div class="details-section">
          <h3>Informacje o gospodarstwie</h3>

          <div class="detail-row">
            <span class="detail-label">Plan:</span>
            <span class="detail-value">{{ selectedHousehold()!.planName }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">
              <p-tag
                [value]="getStatusLabel(selectedHousehold()!.subscriptionStatus)"
                [severity]="getStatusSeverity(selectedHousehold()!.subscriptionStatus)"
              />
            </span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Utworzono:</span>
            <span class="detail-value">{{ formatDate(selectedHousehold()!.createdAt) }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Zaktualizowano:</span>
            <span class="detail-value">{{ formatDate(selectedHousehold()!.updatedAt) }}</span>
          </div>

          @if (selectedHousehold()!.lastActivityAt) {
            <div class="detail-row">
              <span class="detail-label">Ostatnia aktywność:</span>
              <span class="detail-value">{{ formatDate(selectedHousehold()!.lastActivityAt) }}</span>
            </div>
          }
        </div>

        <p-divider></p-divider>

        <!-- Statistics -->
        <div class="details-section">
          <h3>Statystyki</h3>

          <div class="detail-row">
            <span class="detail-label">Członkowie:</span>
            <span class="detail-value">
              {{ selectedHousehold()!.memberCount }}
              @if (selectedHousehold()!.maxMembers) {
                / {{ selectedHousehold()!.maxMembers }}
              }
            </span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Elementy:</span>
            <span class="detail-value">
              {{ selectedHousehold()!.itemCount }}
              @if (selectedHousehold()!.maxItems) {
                / {{ selectedHousehold()!.maxItems }}
              }
            </span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Aktywne zadania:</span>
            <span class="detail-value">{{ selectedHousehold()!.taskCount }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Ukończone zadania:</span>
            <span class="detail-value">{{ selectedHousehold()!.completedTasksCount }}</span>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Members List -->
        <div class="members-section">
          <h3>Członkowie ({{ selectedHousehold()!.members.length }})</h3>

          @if (selectedHousehold()!.members.length > 0) {
            <div class="members-list">
              @for (member of selectedHousehold()!.members; track member.id) {
                <div class="member-item">
                  <div class="member-info">
                    <div class="member-name">
                      {{ member.firstName }} {{ member.lastName }}
                    </div>
                    <div class="member-email">{{ member.email }}</div>
                  </div>
                  <p-tag [value]="member.role" />
                </div>
              }
            </div>
          } @else {
            <p class="no-members">Nie znaleziono członków</p>
          }
        </div>
      </p-card>
    }
  </p-dialog>

  <!-- Create Dialog -->
    <p-dialog
      [(visible)]="createDialogVisible"
      [modal]="true"
      [style]="{ width: '35rem' }"
      header="Utwórz nowe gospodarstwo"
      (onHide)="hideCreateDialog()"
      [closable]="true"
      [draggable]="false"
      [resizable]="false"
    >
    <app-create-household-dialog
      (householdCreated)="refresh()"
      (dialogClosed)="hideCreateDialog()"
    />
  </p-dialog>

  <!-- Toast Messages -->
  <p-toast />

  <!-- Confirmation Dialog -->
  <p-confirmDialog />
</div>
