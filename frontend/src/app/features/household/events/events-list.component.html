<div class="events-view-container">
  <!-- Header -->
  <div class="events-header">
    <div class="header-content">
      <div class="header-text">
        <h1 class="page-title">
          <i class="pi pi-calendar" aria-hidden="true"></i>
          Wydarzenia
        </h1>
        <p class="subtitle">Zarządzaj zaplanowanymi wydarzeniami i terminami</p>
      </div>
      <!-- <div class="header-actions">
        <p-button
          label="Dodaj wydarzenie"
          icon="pi pi-plus"
          (onClick)="openCreateEventDialog()"
          severity="success"
        ></p-button>
      </div> -->
    </div>
  </div>

  <p-divider></p-divider>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <!-- <p-card class="stat-card">
      <div class="stat-content">
        <i class="pi pi-calendar stat-icon"></i>
        <div class="stat-details">
          <div class="stat-value">{{ statusCounters().total }}</div>
          <div class="stat-label">Wszystkie</div>
        </div>
      </div>
    </p-card> -->

    <p-card class="stat-card">
      <div class="stat-content">
        <i class="pi pi-clock stat-icon info"></i>
        <div class="stat-details">
          <div class="stat-value">{{ statusCounters().pending }}</div>
          <div class="stat-label">Oczekujące</div>
        </div>
      </div>
    </p-card>

    <p-card class="stat-card">
      <div class="stat-content">
        <i class="pi pi-check-circle stat-icon success"></i>
        <div class="stat-details">
          <div class="stat-value">{{ statusCounters().completed }}</div>
          <div class="stat-label">Wykonane</div>
        </div>
      </div>
    </p-card>

    <p-card class="stat-card">
      <div class="stat-content">
        <i class="pi pi-history stat-icon warning"></i>
        <div class="stat-details">
          <div class="stat-value">{{ statusCounters().postponed }}</div>
          <div class="stat-label">Przełożone</div>
        </div>
      </div>
    </p-card>

    <p-card class="stat-card">
      <div class="stat-content">
        <i class="pi pi-exclamation-triangle stat-icon danger"></i>
        <div class="stat-details">
          <div class="stat-value">{{ statusCounters().overdue }}</div>
          <div class="stat-label">Przekroczone</div>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Filters Toolbar -->
  <p-card class="filters-card">
    <div class="filters-toolbar">
      <!-- Search -->
      <div class="filter-item search-filter">
        <label>Wyszukiwanie</label>
        <p-iconField iconPosition="left" [styleClass]="'w-full'">
          <p-inputIcon [styleClass]="'pi pi-search'" />
          <input
            type="text"
            pInputText
            [ngModel]="searchText()"
            (ngModelChange)="onSearch($event)"
            placeholder="Szukaj wydarzeń..."
            class="w-full"
          />
        </p-iconField>
      </div>

      <!-- Assignee Filter -->
      <div class="filter-item">
        <label>Osoba odpowiedzialna</label>
        <p-select
          [options]="assigneeOptions()"
          [ngModel]="selectedAssigneeId()"
          (ngModelChange)="onAssigneeFilterChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz osobę"
          [styleClass]="'w-full'"
          [showClear]="true"
        ></p-select>
      </div>

      <!-- Category Filter -->
      <div class="filter-item">
        <label>Kategoria</label>
        <p-select
          [options]="categoryOptions()"
          [ngModel]="selectedCategoryId()"
          (ngModelChange)="onCategoryFilterChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz kategorię"
          [styleClass]="'w-full'"
          [showClear]="true"
        ></p-select>
      </div>

      <!-- Priority Filter -->
      <div class="filter-item">
        <label>Priorytet</label>
        <p-select
          [options]="priorityOptions"
          [ngModel]="selectedPriority()"
          (ngModelChange)="onPriorityFilterChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz priorytet"
          [styleClass]="'w-full'"
          [showClear]="true"
        ></p-select>
      </div>

      <!-- Status Filter -->
      <div class="filter-item">
        <label>Status</label>
        <p-select
          [options]="statusOptions"
          [ngModel]="selectedStatus()"
          (ngModelChange)="onStatusFilterChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz status"
          [styleClass]="'w-full'"
          [showClear]="true"
        ></p-select>
      </div>

      <!-- Date Range Filter -->
      <div class="filter-item date-range">
        <label>Zakres dat</label>
        <div class="date-range-inputs">
          <p-datepicker
            [ngModel]="startDate()"
            (ngModelChange)="startDate.set($event); onDateRangeChange()"
            placeholder="Od"
            [dateFormat]="'dd.mm.yy'"
            [showIcon]="true"
            [styleClass]="'w-full'"
            [showOnFocus]="false"
          ></p-datepicker>
          <span class="date-separator">-</span>
          <p-datepicker
            [ngModel]="endDate()"
            (ngModelChange)="endDate.set($event); onDateRangeChange()"
            placeholder="Do"
            [dateFormat]="'dd.mm.yy'"
            [showIcon]="true"
            [styleClass]="'w-full'"
            [showOnFocus]="false"
          ></p-datepicker>
        </div>
      </div>

      <!-- Sort -->
      <div class="filter-item">
        <label>Sortowanie</label>
        <p-select
          [options]="sortOptions"
          [ngModel]="sortBy()"
          (ngModelChange)="onSortChange($event)"
          optionLabel="label"
          optionValue="value"
          [styleClass]="'w-full'"
        ></p-select>
      </div>

      <!-- Actions -->
      <div class="filter-actions">
        <p-button
          label="Przekroczone"
          [icon]="showOverdueOnly() ? 'pi pi-check-square' : 'pi pi-square'"
          (onClick)="toggleOverdueFilter()"
          [outlined]="!showOverdueOnly()"
          severity="danger"
          size="small"
        ></p-button>
        <p-button
          label="Resetuj filtry"
          icon="pi pi-filter-slash"
          (onClick)="resetFilters()"
          [outlined]="true"
          severity="secondary"
          size="small"
        ></p-button>
        <p-button
          label="Odśwież"
          icon="pi pi-refresh"
          (onClick)="refresh()"
          [outlined]="true"
          severity="secondary"
          size="small"
        ></p-button>
      </div>
    </div>
  </p-card>

  <!-- Results Info -->
  <div class="results-info">
    <p>
      @if (searchText()) {
        Znaleziono <strong>{{ filteredEventsCount() }}</strong> z <strong>{{ totalItems() }}</strong> wydarzeń
      } @else {
        Wyświetlam <strong>{{ filteredEventsCount() }}</strong> z <strong>{{ totalItems() }}</strong> wydarzeń
      }
    </p>
  </div>

  <!-- Events List -->
  @if (isLoading()) {
    <!-- Loading Skeletons -->
    <div class="events-list">
      @for (i of [1, 2, 3, 4, 5]; track i) {
        <p-card class="event-card">
          <p-skeleton width="100%" height="2rem"></p-skeleton>
          <p-skeleton width="80%" height="1.5rem" [styleClass]="'mt-2'"></p-skeleton>
          <p-skeleton width="60%" height="1rem" [styleClass]="'mt-2'"></p-skeleton>
        </p-card>
      }
    </div>
  } @else if (errorMessage()) {
    <!-- Error Message -->
    <p-message severity="error" [text]="errorMessage()!"></p-message>
  } @else if (filteredEvents().length === 0) {
    <!-- No Events -->
    <p-card class="empty-state">
      <div class="empty-content">
        <i class="pi pi-calendar-times empty-icon"></i>
        <h3>Brak wydarzeń</h3>
        <p>
          @if (searchText() || selectedAssigneeId() || selectedCategoryId() || selectedPriority() || selectedStatus()) {
            Nie znaleziono wydarzeń spełniających kryteria wyszukiwania.
            <br>
            Spróbuj zmienić filtry.
          } @else {
            Nie masz jeszcze żadnych zaplanowanych wydarzeń.
            <br>
            Utwórz wydarzenia z widoku Zadania.
          }
        </p>
      </div>
    </p-card>
  } @else {
    <!-- Events Cards -->
    <div class="events-list">
      @for (event of filteredEvents(); track event.id) {
        <p-card class="event-card" [ngClass]="'urgency-' + getEventUrgency(event)">
          <div class="event-header">
            <div class="event-title-section">
              <h3 class="event-title">{{ event.taskName }}</h3>
              <p class="event-category">{{ getCategoryNameForEvent(event) }}</p>
              <p>{{formatEventDate(event.dueDate)}} ({{event.dueDate | date:'dd.MM.yyyy' }})</p>
            </div>
            <div class="event-badges">
              <p-tag
                [value]="formatEventDate(event.dueDate)"
                [severity]="getUrgencySeverity(getEventUrgency(event))"
                icon="pi pi-calendar"
              ></p-tag>
              <p-tag
                [value]="getEventStatusLabel(event.status)"
                [severity]="getEventStatusSeverity(event.status)"
              ></p-tag>
              <p-tag
                [value]="getPriorityLabel(event.priority)"
                [severity]="getPrioritySeverity(event.priority)"
              ></p-tag>
            </div>
          </div>

          <p-divider></p-divider>

          <div class="event-details">
            @if (getTaskDescriptionForEvent(event)) {
              <p class="event-description">{{ getTaskDescriptionForEvent(event) }}</p>
            }

            <div class="event-meta">
              <div class="meta-item">
                <i class="pi pi-user"></i>
                <span>{{ getUserNameForEvent(event) }}</span>
              </div>
              @if (event.isOverdue) {
                <div class="meta-item overdue-warning">
                  <i class="pi pi-exclamation-triangle"></i>
                  <span>Przekroczony termin</span>
                </div>
              }
            </div>

            @if (event.notes) {
              <div class="event-notes">
                <i class="pi pi-comment"></i>
                <span>{{ event.notes }}</span>
              </div>
            }
          </div>

          <p-divider></p-divider>

          <div class="event-actions">
            @if (event.status === 'pending' || event.status === 'postponed') {
              <p-button
                label="Potwierdź"
                icon="pi pi-check"
                (onClick)="completeEvent(event)"
                severity="success"
                size="small"
                [outlined]="true"
              ></p-button>
              <p-button
                label="Przełóż"
                icon="pi pi-clock"
                (onClick)="postponeEvent(event)"
                severity="warn"
                size="small"
                [outlined]="true"
              ></p-button>
              <p-button
                label="Anuluj"
                icon="pi pi-times"
                (onClick)="cancelEvent(event)"
                severity="danger"
                size="small"
                [outlined]="true"
              ></p-button>
            }
            <p-button
              label="Szczegóły"
              icon="pi pi-info-circle"
              (onClick)="openEventDetails(event)"
              severity="info"
              size="small"
              [outlined]="true"
            ></p-button>
            <p-button
              icon="pi pi-trash"
              (onClick)="deleteEvent(event)"
              severity="danger"
              size="small"
              [outlined]="true"
              [text]="true"
              pTooltip="Usuń wydarzenie"
            ></p-button>
          </div>
        </p-card>
      }
    </div>

    <!-- Pagination -->
    <p-paginator
      [rows]="itemsPerPage()"
      [totalRecords]="totalItems()"
      [first]="(currentPage() - 1) * itemsPerPage()"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      (onPageChange)="onPageChange($event)"
      [styleClass]="'mt-4'"
    ></p-paginator>
  }
</div>

<!-- Event Details Dialog (Placeholder) -->
<p-dialog
  [(visible)]="eventDetailsDialogVisible"
  [header]="selectedEvent() ? selectedEvent()!.taskName : 'Szczegóły wydarzenia'"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '50vw', maxWidth: '600px' }"
  (onHide)="hideEventDetailsDialog()"
>
  @if (selectedEvent()) {
    <div class="event-details-dialog">
      <p><strong>Kategoria:</strong> {{ getCategoryNameForEvent(selectedEvent()!) }}</p>
      <p><strong>Termin:</strong> {{ formatEventDate(selectedEvent()!.dueDate) }}</p>
      <p><strong>Status:</strong> {{ getEventStatusLabel(selectedEvent()!.status) }}</p>
      <p><strong>Priorytet:</strong> {{ getPriorityLabel(selectedEvent()!.priority) }}</p>
      <p><strong>Osoba odpowiedzialna:</strong> {{ getUserNameForEvent(selectedEvent()!) }}</p>

      @if (getTaskDescriptionForEvent(selectedEvent()!)) {
        <p><strong>Opis:</strong> {{ getTaskDescriptionForEvent(selectedEvent()!) }}</p>
      }

      @if (selectedEvent()!.notes) {
        <p><strong>Notatki:</strong> {{ selectedEvent()!.notes }}</p>
      }

      @if (selectedEvent()!.completionDate) {
        <p><strong>Data wykonania:</strong> {{ formatEventDate(selectedEvent()!.completionDate!) }}</p>
      }

      @if (selectedEvent()!.completionNotes) {
        <p><strong>Notatki o wykonaniu:</strong> {{ selectedEvent()!.completionNotes }}</p>
      }

      @if (selectedEvent()!.postponeReason) {
        <p><strong>Powód przełożenia:</strong> {{ selectedEvent()!.postponeReason }}</p>
      }

      @if (selectedEvent()!.postponedFromDate) {
        <p><strong>Oryginalna data:</strong> {{ formatEventDate(selectedEvent()!.postponedFromDate!) }}</p>
      }

      <p class="text-sm text-gray-500 mt-4">
        Utworzone: {{ formatEventDate(selectedEvent()!.createdAt) }} przez {{ getCreatorNameForEvent(selectedEvent()!) }}
      </p>
    </div>
  }

  <ng-template pTemplate="footer">
    <div class="dialog-footer-actions">
      @if (selectedEvent() && (selectedEvent()!.status === 'pending' || selectedEvent()!.status === 'postponed')) {
        <p-button
          label="Potwierdź"
          icon="pi pi-check"
          (onClick)="completeEvent(selectedEvent()!); hideEventDetailsDialog()"
          severity="success"
        ></p-button>
        <p-button
          label="Przełóż"
          icon="pi pi-clock"
          (onClick)="postponeEvent(selectedEvent()!); hideEventDetailsDialog()"
          severity="warn"
          [outlined]="true"
        ></p-button>
        <p-button
          label="Anuluj wydarzenie"
          icon="pi pi-times-circle"
          (onClick)="cancelEvent(selectedEvent()!); hideEventDetailsDialog()"
          severity="danger"
          [outlined]="true"
        ></p-button>
      }
      <p-button
        label="Zamknij"
        icon="pi pi-times"
        (onClick)="hideEventDetailsDialog()"
        severity="secondary"
        [outlined]="true"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Create Event Dialog -->
<p-dialog
  [(visible)]="createEventDialogVisible"
  header="Dodaj nowe wydarzenie"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '50vw', maxWidth: '600px' }"
  (onHide)="closeCreateEventDialog()"
>
  <div class="create-event-dialog">
    <div class="form-grid">
      <!-- Task Selection -->
      <div class="form-field">
        <label for="task-select"><span class="required">*</span> Zadanie</label>
        <p-select
          id="task-select"
          [options]="taskDropdownOptions()"
          [ngModel]="newEventTaskId()"
          (ngModelChange)="newEventTaskId.set($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz zadanie"
          [styleClass]="'w-full'"
          [showClear]="false"
        ></p-select>
      </div>

      <!-- Due Date -->
      <div class="form-field">
        <label for="due-date"><span class="required">*</span> Data wykonania</label>
        <p-datepicker
          id="due-date"
          [ngModel]="newEventDueDate()"
          (ngModelChange)="newEventDueDate.set($event)"
          placeholder="Wybierz datę"
          [dateFormat]="'dd.mm.yy'"
          [showIcon]="true"
          [styleClass]="'w-full'"
          appendTo="body"
          [showOnFocus]="false"
        ></p-datepicker>
      </div>

      <!-- Priority -->
      <div class="form-field">
        <label for="priority-select">Priorytet</label>
        <p-select
          id="priority-select"
          [options]="priorityOptions"
          [ngModel]="newEventPriority()"
          (ngModelChange)="newEventPriority.set($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz priorytet (domyślnie z zadania)"
          [styleClass]="'w-full'"
          [showClear]="true"
        ></p-select>
      </div>

      <!-- Assigned Member -->
      <div class="form-field">
        <label for="assignee-select"><span class="required">*</span> Osoba odpowiedzialna</label>
        <p-select
          id="assignee-select"
          [options]="assigneeDropdownOptions()"
          [ngModel]="newEventAssignedToId()"
          (ngModelChange)="newEventAssignedToId.set($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz osobę"
          [styleClass]="'w-full'"
          [showClear]="false"
        ></p-select>
      </div>

      <!-- Notes -->
      <div class="form-field full-width">
        <label for="notes-input">Notatki</label>
        <textarea
          id="notes-input"
          pTextarea
          [ngModel]="newEventNotes()"
          (ngModelChange)="newEventNotes.set($event)"
          placeholder="Dodatkowe informacje..."
          rows="4"
          class="w-full"
        ></textarea>
      </div>
    </div>

    <p class="form-help-text">
      <span class="required">*</span> Pola wymagane
    </p>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Anuluj"
      icon="pi pi-times"
      (onClick)="closeCreateEventDialog()"
      severity="secondary"
      [outlined]="true"
    ></p-button>
    <p-button
      label="Utwórz wydarzenie"
      icon="pi pi-check"
      (onClick)="submitCreateEvent()"
      severity="success"
    ></p-button>
  </ng-template>
</p-dialog>
