<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '600px', maxWidth: '90vw' }"
  header="Utwórz wydarzenie"
  (onHide)="closeDialog()"
>
  @if (task) {
    <!-- Task Information -->
    <div class="task-info-section">
      <h3 class="task-info-title">
        <i class="pi pi-info-circle"></i>
        Informacje o zadaniu
      </h3>

      <div class="task-info-grid">
        <div class="task-info-item">
          <span class="info-label">Nazwa:</span>
          <span class="info-value">{{ task.name }}</span>
        </div>

        <div class="task-info-item">
          <span class="info-label">Kategoria:</span>
          <span class="info-value">
            {{ task.category.categoryType.name }} → {{ task.category.name }}
          </span>
        </div>

        <div class="task-info-item">
          <span class="info-label">Priorytet:</span>
          <p-tag
            [value]="getPriorityLabel(task.priority)"
            [severity]="getPrioritySeverity(task.priority)"
          ></p-tag>
        </div>

        <div class="task-info-item">
          <span class="info-label">Interwał:</span>
          <span class="info-value">{{ formatInterval(task.interval) }}</span>
        </div>
      </div>
    </div>

    <p-divider></p-divider>
  }

  <!-- Event Form -->
  <form [formGroup]="createEventForm" (ngSubmit)="onSubmit()">
    <!-- Cascading Selection (only when no task provided) -->
    @if (!task) {
      <!-- Category Type Selection -->
      <div class="form-field">
        <label for="categoryTypeSelect" class="form-label">
          Typ kategorii *
        </label>
        <p-select
          id="categoryTypeSelect"
          formControlName="categoryTypeId"
          [options]="categoryTypeOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz typ kategorii"
          [style]="{ width: '100%' }"
          [disabled]="categoryTypeOptions().length === 0"
          (onChange)="onCategoryTypeChange($event.value)"
        ></p-select>
        @if (categoryTypeOptions().length === 0) {
          <small class="form-info">
            <i class="pi pi-info-circle"></i>
            Brak dostępnych typów kategorii.
          </small>
        }
        <div class="form-error-container">
          @if (createEventForm.get('categoryTypeId')?.invalid && createEventForm.get('categoryTypeId')?.touched) {
            <small class="form-error">Typ kategorii jest wymagany</small>
          }
        </div>
      </div>

      <!-- Category Selection (filtered by Category Type) -->
      <div class="form-field">
        <label for="categorySelect" class="form-label">
          Kategoria *
        </label>
        <p-select
          id="categorySelect"
          formControlName="categoryId"
          [options]="categoryOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz kategorię"
          [style]="{ width: '100%' }"
          [disabled]="!selectedCategoryTypeId() || categoryOptions().length === 0"
          (onChange)="onCategoryChange($event.value)"
        ></p-select>
        @if (!selectedCategoryTypeId()) {
          <small class="form-info">
            <i class="pi pi-info-circle"></i>
            Najpierw wybierz typ kategorii.
          </small>
        } @else if (categoryOptions().length === 0) {
          <small class="form-info">
            <i class="pi pi-info-circle"></i>
            Brak kategorii dla wybranego typu.
          </small>
        }
        <div class="form-error-container">
          @if (createEventForm.get('categoryId')?.invalid && createEventForm.get('categoryId')?.touched) {
            <small class="form-error">Kategoria jest wymagana</small>
          }
        </div>
      </div>

      <!-- Task Selection (filtered by Category, only one-time tasks) -->
      <div class="form-field">
        <label for="taskSelect" class="form-label">
          Zadanie jednorazowe *
        </label>
        <p-select
          id="taskSelect"
          formControlName="taskId"
          [options]="taskOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz zadanie jednorazowe"
          [style]="{ width: '100%' }"
          [disabled]="!selectedCategoryId() || taskOptions().length === 0"
          [filter]="taskOptions().length > 5"
          filterPlaceholder="Szukaj zadania..."
        ></p-select>
        @if (!selectedCategoryId()) {
          <small class="form-info">
            <i class="pi pi-info-circle"></i>
            Najpierw wybierz kategorię.
          </small>
        } @else if (taskOptions().length === 0) {
          <small class="form-info">
            <i class="pi pi-info-circle"></i>
            Brak zadań jednorazowych w wybranej kategorii.
          </small>
        }
        <div class="form-error-container">
          @if (createEventForm.get('taskId')?.invalid && createEventForm.get('taskId')?.touched) {
            <small class="form-error">Zadanie jest wymagane</small>
          }
        </div>
      </div>
    }
      <!-- Assigned To -->
      <div class="form-field">
        <label for="assignedTo" class="form-label">
          Przypisz do *
        </label>
        <p-select
          id="assignedTo"
          formControlName="assignedTo"
          [options]="memberOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Wybierz osobę odpowiedzialną"
          [style]="{ width: '100%' }"
          [disabled]="memberOptions().length === 0"
        ></p-select>
        @if (memberOptions().length === 0) {
          <small class="form-info">
            <i class="pi pi-info-circle"></i>
            Brak członków gospodarstwa. Upewnij się, że jesteś zalogowany i masz dostęp do gospodarstwa.
          </small>
        }
        <div class="form-error-container">
          @if (createEventForm.get('assignedTo')?.invalid && createEventForm.get('assignedTo')?.touched) {
            <small class="form-error">Osoba odpowiedzialna jest wymagana</small>
          }
        </div>
      </div>

      <!-- Due Date -->
      <div class="form-field">
        <label for="dueDate" class="form-label">
          Data terminu *
        </label>
        <p-datepicker
          id="dueDate"
          formControlName="dueDate"
          [minDate]="minDate"
          [showIcon]="true"
          [showButtonBar]="true"
          dateFormat="dd.mm.yy"
          placeholder="Wybierz datę"
          [style]="{ width: '100%' }"
          appendTo="body"
        ></p-datepicker>
        <div class="form-error-container">
          @if (createEventForm.get('dueDate')?.invalid && createEventForm.get('dueDate')?.touched) {
            <small class="form-error">Data terminu jest wymagana</small>
          }
        </div>
      </div>

    <!-- Priority -->
    <div class="form-field">
      <label for="priority" class="form-label">
        Priorytet *
      </label>
      <p-select
        id="priority"
        formControlName="priority"
        [options]="priorityOptions"
        optionLabel="label"
        optionValue="value"
        [style]="{ width: '100%' }"
      ></p-select>
      @if (task) {
        <small class="form-info">
          <i class="pi pi-info-circle"></i>
          Priorytet dziedziczony z zadania ({{ getPriorityLabel(task.priority) }}). Możesz go zmienić.
        </small>
      }
    </div>

    <!-- Notes -->
    <div class="form-field">
      <label for="notes" class="form-label">
        Notatki
      </label>
      <textarea
        pTextarea
        id="notes"
        formControlName="notes"
        placeholder="Dodatkowe informacje o wydarzeniu..."
        rows="3"
        [style]="{ width: '100%' }"
      ></textarea>
    </div>
  </form>

  <!-- Footer buttons -->
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button
        label="Anuluj"
        icon="pi pi-times"
        [outlined]="true"
        severity="secondary"
        (onClick)="closeDialog()"
        [disabled]="isLoading()"
      ></p-button>
      <p-button
        label="Utwórz wydarzenie"
        icon="pi pi-calendar-plus"
        (onClick)="onSubmit()"
        [loading]="isLoading()"
        [disabled]="createEventForm.invalid"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
