# GitHub Actions Workflow - Terraform Infrastructure Deployment
#
# This workflow deploys AWS infrastructure using Terraform
#
# Features:
# - Manual workflow dispatch only (safety first!)
# - Option to run only 'terraform plan' (dry run)
# - Separate workflows for dev and prod environments
# - Shows detailed plan output before apply
#
# Prerequisites:
# - AWS credentials configured (access keys or OIDC)
# - Terraform backend initialized (S3 + DynamoDB)
# - terraform.tfvars configured for each environment

name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      plan_only:
        description: 'Only run terraform plan (do not apply changes)'
        required: false
        default: true
        type: boolean
      auto_approve:
        description: 'Auto-approve apply (skip manual confirmation)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write  # For posting plan output as comment (if triggered from PR)

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.plan_only == 'true' && 'Plan' || 'Apply' }}
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      PLAN_ONLY: ${{ github.event.inputs.plan_only }}
      AUTO_APPROVE: ${{ github.event.inputs.auto_approve }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}

    defaults:
      run:
        working-directory: infrastructure/environments/${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.1
          terraform_wrapper: true

      - name: Configure AWS credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1

      - name: Verify environment
        run: |
          echo "üåç Environment: $ENVIRONMENT"
          echo "üìã Plan Only: $PLAN_ONLY"
          echo "‚úÖ Auto Approve: $AUTO_APPROVE"
          echo ""
          echo "Working Directory: $(pwd)"
          ls -la

      - name: Terraform Init
        id: init
        run: |
          echo "Initializing Terraform..."
          terraform init -input=false

      - name: Terraform Validate
        id: validate
        run: |
          echo "Validating Terraform configuration..."
          terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          echo "Running Terraform plan..."
          terraform plan -no-color -input=false -out=tfplan
        continue-on-error: false

      - name: Save Plan Output
        if: always()
        run: |
          terraform show -no-color tfplan > plan-output.txt
          echo "Plan output saved to plan-output.txt"

      - name: Upload Plan Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ env.ENVIRONMENT }}-${{ github.run_number }}
          path: infrastructure/environments/${{ env.ENVIRONMENT }}/plan-output.txt
          retention-days: 30

      - name: Check for changes
        id: changes
        run: |
          if terraform show -no-color tfplan | grep -q "No changes"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No infrastructure changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Infrastructure changes detected"
          fi

      - name: Plan Only - Exit
        if: env.PLAN_ONLY == 'true'
        run: |
          echo "================================"
          echo "üìã PLAN ONLY MODE"
          echo "================================"
          echo ""
          echo "Terraform plan completed successfully!"
          echo "No changes were applied to infrastructure."
          echo ""
          echo "To apply these changes:"
          echo "1. Review the plan output above"
          echo "2. Run the workflow again with 'Only plan' unchecked"
          echo ""
          echo "Plan artifact uploaded for review."
          exit 0

      - name: Require confirmation for production
        if: env.PLAN_ONLY == 'false' && env.ENVIRONMENT == 'prod' && env.AUTO_APPROVE == 'false'
        run: |
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT"
          echo "================================"
          echo ""
          echo "You are about to apply changes to PRODUCTION environment!"
          echo "This workflow requires manual confirmation."
          echo ""
          echo "To proceed, run with 'Auto-approve' checked."
          echo "Or use Terraform CLI locally:"
          echo "  cd infrastructure/environments/prod"
          echo "  terraform apply"
          echo ""
          exit 1

      - name: Terraform Apply
        if: env.PLAN_ONLY == 'false' && (env.AUTO_APPROVE == 'true' || env.ENVIRONMENT == 'dev')
        id: apply
        continue-on-error: true
        run: |
          echo "üöÄ Applying Terraform changes..."
          echo "Environment: $ENVIRONMENT"
          echo ""

          if [ "$AUTO_APPROVE" == "true" ]; then
            terraform apply -auto-approve -input=false tfplan
          else
            terraform apply -input=false tfplan
          fi
          
          echo "apply_status=$?" >> $GITHUB_OUTPUT
      
      - name: Check ACM Certificate Status
        if: env.PLAN_ONLY == 'false'
        id: acm_check
        continue-on-error: true
        run: |
          echo "üîç Checking ACM certificate status..."
          
          # Check if apply failed
          if [ "${{ steps.apply.outputs.apply_status }}" != "0" ]; then
            echo "‚ö†Ô∏è Terraform apply had issues - checking if it's certificate related..."
          fi
          
          # Get certificate ARN from outputs
          CERT_ARN=$(terraform output -raw acm_certificate_arn 2>/dev/null || echo "")
          
          if [ -z "$CERT_ARN" ]; then
            echo "No ACM certificate found"
            echo "needs_validation=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Certificate ARN: $CERT_ARN"
          
          # Get certificate status
          CERT_STATUS=$(aws acm describe-certificate \
            --certificate-arn "$CERT_ARN" \
            --region us-east-1 \
            --query 'Certificate.Status' \
            --output text)
          
          echo "Certificate Status: $CERT_STATUS"
          echo "status=$CERT_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$CERT_STATUS" == "PENDING_VALIDATION" ]; then
            echo "needs_validation=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Certificate requires DNS validation!"
          elif [ "$CERT_STATUS" == "ISSUED" ]; then
            echo "needs_validation=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Certificate is already validated!"
          else
            echo "needs_validation=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Certificate status: $CERT_STATUS"
          fi
      
      - name: Display DNS Validation Records
        if: env.PLAN_ONLY == 'false' && steps.acm_check.outputs.needs_validation == 'true'
        run: |
          echo "========================================"
          echo "üîê ACM CERTIFICATE VALIDATION REQUIRED"
          echo "========================================"
          echo ""
          echo "Your SSL certificate has been created but needs DNS validation."
          echo ""
          
          CERT_ARN=$(terraform output -raw acm_certificate_arn)
          
          echo "üìã Add these CNAME records to your OVH DNS:"
          echo ""
          
          # Get validation records
          aws acm describe-certificate \
            --certificate-arn "$CERT_ARN" \
            --region us-east-1 \
            --query 'Certificate.DomainValidationOptions[*].ResourceRecord' \
            --output json | jq -r '.[] | 
              "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
              "Type:       \(.Type)\n" +
              "Name:       \(.Name)\n" +
              "Value:      \(.Value)\n" +
              "\nIn OVH, add as:\n" +
              "  Subdomain:  " + (.Name | sub("\\..*$"; "")) + "\n" +
              "  Type:       CNAME\n" +
              "  Target:     \(.Value)\n"
            '
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üìù INSTRUCTIONS:"
          echo "1. Log in to OVH control panel"
          echo "2. Go to: Domains ‚Üí homely.maflint.com ‚Üí DNS Zone"
          echo "3. Click 'Add entry'"
          echo "4. Select type: CNAME"
          echo "5. Copy the subdomain and target from above"
          echo "6. Save the record"
          echo "7. Wait 5-30 minutes for validation"
          echo ""
          echo "‚è≥ The workflow will now wait for certificate validation..."
          echo ""
      
      - name: Wait for Certificate Validation
        if: env.PLAN_ONLY == 'false' && steps.acm_check.outputs.needs_validation == 'true'
        run: |
          echo "‚è≥ Waiting for ACM certificate validation..."
          echo "This may take 5-30 minutes after you add DNS records."
          echo ""
          
          CERT_ARN=$(terraform output -raw acm_certificate_arn)
          MAX_WAIT=1800  # 30 minutes
          ELAPSED=0
          CHECK_INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws acm describe-certificate \
              --certificate-arn "$CERT_ARN" \
              --region us-east-1 \
              --query 'Certificate.Status' \
              --output text)
            
            echo "[$(date +%H:%M:%S)] Status: $STATUS (waited ${ELAPSED}s / ${MAX_WAIT}s)"
            
            if [ "$STATUS" == "ISSUED" ]; then
              echo ""
              echo "‚úÖ Certificate validated successfully!"
              echo ""
              exit 0
            fi
            
            if [ "$STATUS" == "FAILED" ]; then
              echo ""
              echo "‚ùå Certificate validation failed!"
              echo "Please check your DNS records and try again."
              echo ""
              exit 1
            fi
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done
          
          echo ""
          echo "‚è∞ Timeout waiting for certificate validation"
          echo ""
          echo "The certificate is still pending. This is normal if:"
          echo "1. You haven't added DNS records yet"
          echo "2. DNS propagation is taking longer than usual"
          echo ""
          echo "What to do next:"
          echo "1. Verify DNS records are added correctly in OVH"
          echo "2. Wait a bit longer and run this workflow again"
          echo "3. Check certificate status in AWS Console"
          echo ""
          exit 1
      
      - name: Apply CloudFront Configuration
        if: env.PLAN_ONLY == 'false' && steps.acm_check.outputs.status == 'ISSUED' && steps.apply.outputs.apply_status != '0'
        run: |
          echo "üöÄ Certificate is validated! Applying final CloudFront configuration..."
          echo ""
          
          # Run terraform apply again to update CloudFront with the validated certificate
          terraform apply -auto-approve -input=false
          
          echo ""
          echo "‚úÖ CloudFront configuration updated with SSL certificate!"
      
      - name: Check Final Apply Status
        if: env.PLAN_ONLY == 'false'
        run: |
          # If initial apply failed and it wasn't certificate-related, fail the job
          if [ "${{ steps.apply.outputs.apply_status }}" != "0" ] && [ "${{ steps.acm_check.outputs.needs_validation }}" != "true" ]; then
            echo "‚ùå Terraform apply failed for reasons other than certificate validation"
            exit 1
          fi
          
          # If certificate needs validation, treat as expected state
          if [ "${{ steps.acm_check.outputs.needs_validation }}" == "true" ]; then
            echo "‚úÖ Infrastructure partially deployed - waiting for certificate validation"
            exit 0
          fi
          
          echo "‚úÖ All infrastructure deployed successfully"

      - name: Terraform Output
        if: env.PLAN_ONLY == 'false'
        id: output
        run: |
          echo "üì§ Terraform Outputs:"
          echo "================================"
          terraform output -no-color
          echo ""
          echo "================================"
          echo "üìã Formatted Outputs:"
          echo "================================"
          
          # Display formatted outputs for better readability
          terraform output -json | jq -r '
            to_entries[] | 
            if .value.sensitive then
              "\nüîí \(.key) (sensitive - see artifacts for details)"
            else
              "\nüìå \(.key):\n\(.value.value)"
            end
          '

      - name: Save Terraform Outputs
        if: env.PLAN_ONLY == 'false'
        run: |
          # Save raw JSON
          terraform output -json > outputs.json
          
          # Save formatted text version
          echo "========================================" > outputs-formatted.txt
          echo "Terraform Outputs - $ENVIRONMENT" >> outputs-formatted.txt
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> outputs-formatted.txt
          echo "========================================" >> outputs-formatted.txt
          echo "" >> outputs-formatted.txt
          
          terraform output -json | jq -r '
            to_entries[] | 
            "\n[\(.key)]\n\(.value.value)\n" + ("=" * 40)
          ' >> outputs-formatted.txt
          
          echo ""
          echo "‚úÖ Outputs saved:"
          echo "  - outputs.json (raw JSON)"
          echo "  - outputs-formatted.txt (human-readable)"

      - name: Upload Outputs Artifact
        if: env.PLAN_ONLY == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ env.ENVIRONMENT }}-${{ github.run_number }}
          path: |
            infrastructure/environments/${{ env.ENVIRONMENT }}/outputs.json
            infrastructure/environments/${{ env.ENVIRONMENT }}/outputs-formatted.txt
          retention-days: 90

      - name: Deployment Summary
        if: env.PLAN_ONLY == 'false' && success()
        run: |
          echo "================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "================================"
          echo ""
          echo "Environment: $ENVIRONMENT"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          
          # Check certificate status
          CERT_ARN=$(terraform output -raw acm_certificate_arn 2>/dev/null || echo "")
          if [ -n "$CERT_ARN" ]; then
            CERT_STATUS=$(aws acm describe-certificate \
              --certificate-arn "$CERT_ARN" \
              --region us-east-1 \
              --query 'Certificate.Status' \
              --output text 2>/dev/null || echo "UNKNOWN")
            
            echo "üîê Certificate Status: $CERT_STATUS"
            
            if [ "$CERT_STATUS" == "ISSUED" ]; then
              echo "   ‚úÖ SSL certificate is active!"
              echo "   üåê Your site is available at: https://${{ github.event.inputs.environment }}.homely.maflint.com"
            elif [ "$CERT_STATUS" == "PENDING_VALIDATION" ]; then
              echo "   ‚ö†Ô∏è  SSL certificate is pending DNS validation"
              echo "   üìã Please add the DNS records shown above to OVH"
              echo "   ‚è≥ Then run this workflow again to complete setup"
            fi
          fi
          
          echo ""
          echo "Next steps:"
          
          if [ "$CERT_STATUS" == "PENDING_VALIDATION" ]; then
            echo "1. ‚ö†Ô∏è  Add DNS validation records to OVH (shown above)"
            echo "2. ‚è≥ Wait 5-30 minutes for validation"
            echo "3. üîÑ Run this workflow again to apply certificate"
            echo "4. üåê Then your site will be available at custom domain"
          else
            echo "1. Verify resources in AWS Console"
            echo "2. Check application health"
            echo "3. Deploy frontend/backend if needed"
            echo "4. Monitor CloudWatch logs"
          fi
          
          echo ""
          echo "Outputs are available in the artifacts."

      - name: Post Plan to PR Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infrastructure/environments/${{ env.ENVIRONMENT }}/plan-output.txt', 'utf8');

            const output = `## Terraform Plan - ${{ env.ENVIRONMENT }}

            <details>
            <summary>Show Plan</summary>

            \`\`\`terraform
            ${plan}
            \`\`\`

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Failure Notification
        if: failure()
        run: |
          echo "================================"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "================================"
          echo ""
          echo "Environment: $ENVIRONMENT"
          echo "Action: ${{ env.PLAN_ONLY == 'true' && 'Plan' || 'Apply' }}"
          echo ""
          echo "Check the logs above for error details."
          echo ""
          if [ "$PLAN_ONLY" == "false" ]; then
            echo "Infrastructure may be in an inconsistent state."
            echo "Consider running 'terraform plan' to check current state."
          fi

  notify-success:
    name: Notify on Success
    runs-on: ubuntu-latest
    needs: terraform
    if: success() && github.event.inputs.plan_only == 'false' && github.event.inputs.environment == 'prod'

    steps:
      - name: Production deployment notification
        run: |
          echo "üéâ Production infrastructure deployed successfully!"
          echo "Environment: prod"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "Remember to:"
          echo "1. Verify all resources in AWS Console"
          echo "2. Update DNS records if needed"
          echo "3. Test application deployment"
          echo "4. Monitor CloudWatch logs"

          # Here you could add Slack/Discord/Email notifications
          # Example:
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"Production infrastructure deployed successfully!"}'
