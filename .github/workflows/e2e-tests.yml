name: E2E Tests

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'database/**'
      - 'docker-compose.e2e.yml'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ============================================================================
      # SETUP
      # ============================================================================
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        working-directory: frontend
        run: npx playwright install chromium --with-deps

      # ============================================================================
      # DOCKER SETUP
      # ============================================================================
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build backend Docker image
        run: |
          docker build \
            --build-arg BUILD_ENV=E2E \
            --tag homely-backend-e2e \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --file Dockerfile \
            .
        working-directory: backend

      - name: ðŸš€ Start E2E environment
        run: docker compose -f docker-compose.e2e.yml up -d

      - name: â³ Wait for services to be healthy
        run: |
          echo "â³ Waiting for PostgreSQL..."
          timeout 60 bash -c 'until docker exec homely-postgres-e2e pg_isready -U postgres -d postgres; do sleep 2; done'
          echo "âœ… PostgreSQL is ready"

          echo "â³ Waiting for Backend API..."
          timeout 60 bash -c 'until curl -f http://127.0.0.1:8081/health; do sleep 2; done'
          echo "âœ… Backend API is ready"

      - name: ðŸ“Š Display container status (on success)
        if: success()
        run: docker compose -f docker-compose.e2e.yml ps

      - name: ðŸ“Š Display container status (on failure)
        if: failure()
        run: |
          echo "âš ï¸ Previous step failed. Checking container status..."
          docker compose -f docker-compose.e2e.yml ps || echo "Failed to get container status"

      # ============================================================================
      # PRE-FLIGHT CHECKS - Verify Playwright can access services
      # ============================================================================
      - name: ðŸ” Verify backend connectivity (from Playwright perspective)
        if: success()
        run: |
          echo "ðŸ” Testing backend connectivity from host (Playwright will use same network)..."
          echo ""

          # Test 1: Health endpoint HTTP status
          echo "1ï¸âƒ£ Testing /health endpoint HTTP status..."
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8081/health)
          if [ "$HEALTH_RESPONSE" -eq 200 ]; then
            echo "âœ… Backend /health responds with HTTP 200"
          else
            echo "âŒ Backend /health returned HTTP $HEALTH_RESPONSE (expected 200)"
            exit 1
          fi

          # Test 2: Get health endpoint content
          echo ""
          echo "2ï¸âƒ£ Testing /health endpoint content..."
          HEALTH_CONTENT=$(curl -s http://127.0.0.1:8081/health)
          if [ -n "$HEALTH_CONTENT" ]; then
            echo "âœ… Backend /health returned content:"
            echo "$HEALTH_CONTENT" | head -10
          else
            echo "âŒ Backend /health returned empty response"
            exit 1
          fi

          # Test 3: Verify port bindings
          echo ""
          echo "3ï¸âƒ£ Verifying port bindings..."
          docker compose -f docker-compose.e2e.yml ps
          echo ""
          echo "Open ports:"
          netstat -tlnp 2>/dev/null | grep -E '(8081|54011)' || ss -tlnp 2>/dev/null | grep -E '(8081|54011)' || echo "âš ï¸ netstat/ss not available, skipping port check"

          echo ""
          echo "âœ… All pre-flight checks passed! Playwright can access backend on 127.0.0.1:8081"

      # ============================================================================
      # RUN TESTS
      # ============================================================================
      - name: ðŸ§ª Run E2E tests
        if: success()
        working-directory: frontend
        run: npx playwright test category-management.spec.ts
        env:
          CI: true

      # ============================================================================
      # ARTIFACT UPLOAD ON FAILURE
      # ============================================================================
      - name: ðŸ“¸ Upload test artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ github.run_number }}
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 30
          if-no-files-found: ignore

      - name: ðŸ“¹ Upload Playwright traces (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-${{ github.run_number }}
          path: frontend/test-results/**/*.zip
          retention-days: 30
          if-no-files-found: ignore

      # ============================================================================
      # LOGS AND CLEANUP
      # ============================================================================
      - name: ðŸ“‹ Display Docker logs (on failure)
        if: failure()
        run: |
          echo "========== PostgreSQL Logs =========="
          docker compose -f docker-compose.e2e.yml logs postgres-e2e || echo "Failed to get PostgreSQL logs"
          echo ""
          echo "========== Backend Logs =========="
          docker compose -f docker-compose.e2e.yml logs backend-e2e || echo "Failed to get backend logs"

      - name: ðŸ§¹ Cleanup E2E environment
        if: always()
        run: docker compose -f docker-compose.e2e.yml down -v || echo "Cleanup completed with warnings"

      # ============================================================================
      # SUMMARY
      # ============================================================================
      - name: ðŸ“Š Generate test summary
        if: always()
        run: |
          if [ -f frontend/playwright-report/index.html ]; then
            echo "## ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Tests completed. View detailed report in artifacts." >> $GITHUB_STEP_SUMMARY
          fi
